<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Graph</title>
    <link rel="stylesheet" href="./graph.css"/>
</head>
<body>
<script src="JsonGraph.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
    /* layout */
    const width = 800;
    const height = 800;

    const nodeWidth = 80;
    const nodeHeight = 40;

    /* graphics */
    const svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);
    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("display", "none");

    const nodes = [];
    nodes.push({
            "name": "START",
            "x": 400,
            "y": 200,
            "id": 0,
            "in": [],
            "out": [
                {"port": 0, "attr": {}},
                {"port": 1, "attr": {}},
                {"port": 2, "attr": {}}
            ],
            "sub": [],
            "attr": {
                "a": "A",
                "b": "B"
            },
        },
        {
            "name": "END",
            "x": 400,
            "y": 400,
            "id": 1,
            "in": [
                {"port": 0, "attr": {}},
                {"port": 1, "attr": {}},
                {"port": 2, "attr": {}}
            ],
            "out": [],
            "sub": [],
            "attr": {
                "a": "AA",
                "b": "BB"
            }
        });
    const edges = [];
    edges.push({
        "id": 0,
        "from": {
            "node": 0,
            "port": 0
        },
        "to": {
            "node": 1,
            "port": 0
        },
        "attr": {
            "name": "0.0 - 1.0",
            "data": "Path-to-data-file"
        }
    });

    getAttrDesc = (obj) => {
        const attr = obj.attr;
        const keys = Object.keys(attr);
        const len = keys.length;
        let description = "";
        if (len > 0) {
            description += `${keys[0]}: ${attr[keys[0]]}`;
        }
        for (let i = 1; i < len; i++) {
            description += `<br>${keys[i]}: ${attr[keys[i]]}`;
        }
        return description;
    };


    calculatePort = (posX, posY, i) => {
        const x1 = posX - 3;
        const y1 = posY;
        const x2 = posX;
        const y2 = posY + i * 5;
        const x3 = posX + 3;
        const y3 = posY;
        return `${x1},${y1} ${x2},${y2}, ${x3},${y3}`
    };

    calculateLine = (port, in_out, attr) => {
        const n = d3.select(`#n${port.node}`).attr(`data-${attr}`);
        const p = d3.select(`#n${port.node}${in_out}${port.port}`).attr(`data-${attr}`);
        return parseFloat(n) + parseFloat(p);
    };

    /* draw nodes */
    svg.selectAll("g").data(nodes).enter().each((d) => {
        const node = d;
        const n = svg.append("g")
            .attr("transform", `translate(${node.x},${node.y})`);
        n.append("rect")
            .attr('id', `n${node.id}`)
            .attr('data-x', node.x)
            .attr('data-y', node.y)
            .attr("class", "node")
            .attr("width", nodeWidth)
            .attr("height", nodeHeight)
            /* mouse events */
            .on("mouseover", () => {
                tooltip.style("display", "block");
                tooltip.html(`${getAttrDesc(node)}`);
            })
            .on("mouseout", () => {
                tooltip.style("display", "none");
            });
        n.append("text")
            .attr('x', 5)
            .attr('y', nodeHeight / 2 + 5)
            .html(node.name);
        /* draw in ports */
        const inLength = d.in.length;
        const sIn = 1 / (2 * inLength);
        const pin = n.selectAll('polygon').data(d.in).enter();
        pin.append('polygon')
            .attr('id', (d) => `n${node.id}in${d.port}`)
            .attr('data-x', (d) => (2 * d.port + 1) * sIn * nodeWidth)
            .attr('data-y', 0)
            .attr('points', (d) => calculatePort((2 * d.port + 1) * sIn * nodeWidth, 0, 1))
            .attr('class', 'port')
            .on("mouseover", (d) => {
                tooltip.style("display", "block");
                tooltip.html(`${getAttrDesc(d)}`);
            })
            .on("mouseout", (d) => {
                tooltip.style("display", "none");
            });
        /* draw out ports */
        const outLength = d.out.length;
        const sOut = 1 / (2 * outLength);
        const pout = n.selectAll('polygon').data(d.out).enter();
        pout.append('polygon')
            .attr('id', (d) => `n${node.id}out${d.port}`)
            .attr('data-x', (d) => (2 * d.port + 1) * sOut * nodeWidth)
            .attr('data-y', nodeHeight)
            .attr('points', (d) => calculatePort((2 * d.port + 1) * sOut * nodeWidth, nodeHeight, -1))
            .attr('class', 'port')
            .on("mouseover", (d) => {
                tooltip.style("display", "block");
                tooltip.html(`${getAttrDesc(d)}`);
            })
            .on("mouseout", (d) => {
                tooltip.style("display", "none");
            });
    });
    /* draw edges */
    svg.selectAll("line").data(edges)
        .enter().append("line")
        .attr('id', (d) => `e${d.id}`)
        .attr('x1', (d) => calculateLine(d.from, 'out', 'x'))
        .attr('y1', (d) => calculateLine(d.from, 'out', 'y'))
        .attr('x2', (d) => calculateLine(d.to, 'in', 'x'))
        .attr('y2', (d) => calculateLine(d.to, 'in', 'y'))
        .attr("class", "node")
        /* mouse events */
        .on("mouseover", (d) => {
            tooltip.style("display", "block");
            tooltip.html(`${getAttrDesc(d)}`);
        })
        .on("mouseout", (d) => {
            tooltip.style("display", "none");
        });
</script>
</body>
</html>
